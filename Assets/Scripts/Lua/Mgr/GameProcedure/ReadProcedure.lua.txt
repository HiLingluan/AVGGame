-- des:{阅读流程}
-- author:{zpf}
-- date: 2021-12-16 09:33:00
--
local ProcedureBase = require "Mgr.GameProcedure.ProcedureBase"
local ReadProcedure = class("ReadProcedure",ProcedureBase)

--//------------------------------------------------------

function ReadProcedure:ctor()
    ReadProcedure.base(self).ctor(self, Define.EGameProcedure.Read)
end

function ReadProcedure:onInit()
    self.super.onInit(self)
end

function ReadProcedure:onEnter()
    self.super.onEnter(self)
    GameEntry.Sound:StopAllLoadingSounds()
    GameEntry.Sound:StopAllLoadedSounds()
    self.ReadTransitionSystem = require "Logic.Read.SceneSwitchEffect.ReadTransitionSystem"
    self.ReadTransitionSystem:init()
    SoundMgr:StopAll()
    self.fsm:setData("LastProcedure","ReadProcedure")
    
    if LoadingHotUpdate.isEnterRead then
        Log("新手引导流程 无法进入阅读！")
        GameEntry.OutAsset:Clear()
    else
        LoadingToRead.startLoading(function ()
            GameEntry.OutAsset:Clear() 
        end)
    end 

    StatUtil.setCurScene(StatConstant.SCENE.Read)
    StatUtil.setCurPage("Panel_Read")
end

function ReadProcedure:onUpdate()
    self.super.onUpdate(self)

end

function ReadProcedure:onLeave()
    self.super.onLeave(self)
    self.ReadTransitionSystem:destroy()
    StatUtil.setStorySetID("")
    --可以增加阅读UI容器
    ViewMgr:DestroyWindow(EWindowType.ReadPanel)
    ViewMgr:DestroyWindow(EWindowType.DefineName)
    ViewMgr:DestroyWindow(EWindowType.ReadMessage)
    ViewMgr:DestroyWindow(EWindowType.ReadFinal)
    ViewMgr:DestroyWindow(EWindowType.ReadHistory)
    
    --退出阅读重置
    GameEntry.Base.GameSpeed = 1
    ServiceMgr:GetService(EServiceType.ClothPool):resetComponents()
    ServiceMgr:GetService(EServiceType.ReadProp):destroy()

    local recordSystem = ServiceMgr:GetService(EServiceType.SystemRecord)
    recordSystem.isFromNormalRead = true
    recordSystem.isOpenCamera = false
end

function ReadProcedure:onDestroy()
    self.super.onDestroy(self)
end

--//-----------------------------------------------

--阅读预加载
function ReadProcedure:preLoad(func)
    ViewMgr:CloseWindow(EWindowType.Catalogue)
    ViewMgr:DestroyFullPanel()
    local index = 0
    local onFinish = function ()
        index = index + 1
        
        if index >= 2 then
            func()
            local readPanel = ViewMgr:GetWindow(EWindowType.ReadPanel)
            --可以走事件通知
            readPanel:startRead()
        end
    end
    ViewMgr:OpenWindow(EWindowType.ReadPanel,function (window)
        window:preloadFirstRes()
        onFinish()
    end)
    
    self.ReadTransitionSystem:createTransition(onFinish)
end

function ReadProcedure:enterRead()
    HttpMgr.ReqPost(
        LuaNetUrlConfig.joinReadNotice,
        function(code, data)
            if code == 0 then
                --LogError("同步进入阅读成功  StoryID:"..tostring(CS.JMatrix.LuaDataProxy.storyID).."======"..tostring(CS.JMatrix.LuaDataProxy.chapterID).."======"..tostring(CS.JMatrix.LuaDataProxy.setID))
            else
                FLog("同步失败!")
            end
        end,
        {story_id = CS.JMatrix.LuaDataProxy.storyID, chapter_id = CS.JMatrix.LuaDataProxy.chapterID, set_id = CS.JMatrix.LuaDataProxy.setID,game_level_id = CS.JMatrix.LuaDataProxy.gameLevelID}
    )
end

return ReadProcedure
-- des:{资源管理类}
-- author:{daniel}
-- date: 2021-08-19 14:50:00
AssetDownload = {}

local assetService = Context.GetApplicationContext():GetService("AssetService")

function AssetDownload.DownLoad(relativePath, md5, size, downloadingCallback)
    local url = HttpMgr.curCDN .. relativePath
    if not size then
        size = 0
    end
    if not downloadingCallback then
        downloadingCallback = function(progress)
            --留给显示进度条
        end
    end
    local finish = function(code)
        if code == 0 then
            --下载成功
            --插入加载
        else
            ZLog("文件下载失败:" .. tostring(url))
            CommonTools.ShowCommonMsgBox(
                    CommonConfig:getLanguage("lag_procedure_040"),
                    CommonConfig:getLanguage("lag_procedure_045") .. tostring(url),
                    function()
                        AssetDownload.DownLoad(relativePath, md5, size, downloadingCallback)
                    end, CommonConfig:getLanguage("lag_downfail_sure")
            )
        end
    end
    assetService:DownloadAssetInfo(url, relativePath, md5, size, finish, downloadingCallback, -1)
end

--一次性初始化本地资源列表
function AssetDownload.OnceAddLocalAssetsInfo(tab)
    assetService:OnceAddLocalAssetsInfo(rapidjson.encode(tab))
end

--进入大厅必须下载的资源
function AssetDownload.DownloadMainAssets(finish)
    local progressCallback = function(progress)
        --留给显示进度条
        local downloadKey = LoadingConfig.moduleKey.DOWNLOADMAINASSETS .. LoadingConfig.eventKey.DOWNLOADING
        EventMgr.Dispatcher(downloadKey, LoadingConfig.moduleKey.DOWNLOADMAINASSETS, LoadingConfig.eventKey.DOWNLOADING, progress)
    end
    assetService:BeginDownloadToMain(finish, progressCallback)
end

--下载阅读资源（包括了动态场景配置）
function AssetDownload.DownloadReadAssets(finish)
    local progressCallback = function(progress)
        --留给显示进度条
        -- FLog("下载阅读资源进度========="..tostring(progress))
        local downloadKey = LoadingConfig.moduleKey.DOWNLOADREADASSETS .. LoadingConfig.eventKey.DOWNLOADING
        EventMgr.Dispatcher(downloadKey, LoadingConfig.moduleKey.DOWNLOADREADASSETS, LoadingConfig.eventKey.DOWNLOADING, progress)

    end
    CSStoryData:Begin()
    assetService:BeginDownloadToRead(finish, progressCallback)
end

--下载约会资源（包括了动态场景配置）
function AssetDownload.DownloadDateAssets(finish)
    local progressCallback = function(progress)
        --留给显示进度条
        FLog("下载阅读资源进度=========" .. tostring(progress))
        local downloadKey = LoadingConfig.moduleKey.DOWNLOADREADASSETS .. LoadingConfig.eventKey.DOWNLOADING
        EventMgr.Dispatcher(downloadKey, LoadingConfig.moduleKey.DOWNLOADREADASSETS, LoadingConfig.eventKey.DOWNLOADING, progress)

    end
    DateStoryDataMgr:Ins():begin();
    local res = DateStoryDataMgr:Ins():getResourceIds();
    assetService:BeginDownloadToDate(res, finish, progressCallback)--可能也要改成lua端了
end

--下载动态场景资源
function AssetDownload.DownloadDynamicSceneAsset(finish)
    local progressCallback = function(progress)
        --留给显示进度条
        -- FLog("下载动态场景资源进度========="..tostring(progress))
        local downloadKey = LoadingConfig.moduleKey.DOWNLOADDYNAMICASSETS .. LoadingConfig.eventKey.DOWNLOADING
        EventMgr.Dispatcher(downloadKey, LoadingConfig.moduleKey.DOWNLOADDYNAMICASSETS, LoadingConfig.eventKey.DOWNLOADING, progress)
    end
    assetService:BeginDownloadDynamicSceneAsset(finish, progressCallback)
end


--下载约会动态场景资源
function AssetDownload.DownloadDateDynamicSceneAsset(finish)
    local progressCallback = function(progress)
        --留给显示进度条
        -- FLog("下载动态场景资源进度========="..tostring(progress))
        local downloadKey = LoadingConfig.moduleKey.DOWNLOADDYNAMICASSETS .. LoadingConfig.eventKey.DOWNLOADING
        EventMgr.Dispatcher(downloadKey, LoadingConfig.moduleKey.DOWNLOADDYNAMICASSETS, LoadingConfig.eventKey.DOWNLOADING, progress)
    end
    local sceneids = DateStoryDataMgr:Ins():getDySceneIds();
    assetService:BeginDownloadDateDynamicSceneAsset(assetService:GetDateDySceneResIds(sceneids), finish, progressCallback)
end

--后端接口优化后,一次性拿到所有的该集的资源列表
function AssetDownload.BeginDownloadAssetsToReadByResIds(finish)
    local progressCallback = function(progress)
        --留给显示进度条
        local downloadKey = LoadingConfig.moduleKey.DOWNLOADMAINASSETS .. LoadingConfig.eventKey.DOWNLOADING
        EventMgr.Dispatcher(downloadKey, LoadingConfig.moduleKey.DOWNLOADMAINASSETS, LoadingConfig.eventKey.DOWNLOADING, progress)
    end
    assetService:BeginDownloadAssetsToReadByResIds(finish)
end
